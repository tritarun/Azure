name: Push wordpress container on ACR
on:
  push:
    branches:
      - main
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v3
    
    - name: login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: login to ACR
      run: |
        az acr login --name ${{ secrets.ACR_NAME }}

    - name: Pull WP image
      run: |
        docker pull wordpress:latest

    - name: Tag WP image for ACR
      run: |
        docker tag wordpress:latest ${{ secrets.ACR_NAME }}.azurecr.io/wordpress:latest

    - name: Push WP image to ACR
      run: |
        docker push ${{ secrets.ACR_NAME }}.azurecr.io/wordpress:latest
    
    # - name: Create Azure App Service Plan
    #   run: |
    #     az appservice plan create --name ${{ secrets.APP_SERVICE_PLAN_NAME }} --resource-group ${{ secrets.RESOURCE_GROUP }} --sku B1 --is-linux

    - name: Create Azure Web App for Containers
      run: |
        az webapp create --resource-group Tarun-RG --plan githubtestingplan --name ${{ secrets.APP_SERVICE_NAME }} --deployment-container-image-name ${{ secrets.ACR_NAME }}.azurecr.io/wordpress:latest

    - name: Configure Web App with ACR
      run: |
        az webapp config container set --name ${{ secrets.APP_SERVICE_NAME }} --resource-group Tarun-RG --docker-custom-image-name ${{ secrets.ACR_NAME }}.azurecr.io/wordpress:latest

    - name: Logout of Azure
      run: az logout

  